<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banking App UI</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/sip.js@0.21.2/lib/platform/web/sip.min.js"></script>
    <script src="sip-config.js"></script>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo">
                <div class="dollar-logo">$</div>
            </div>
            <nav>
                <ul>
                    <li class="active">All</li>
                    <li>Offers</li>
                    <li>Highlights</li>
                </ul>
            </nav>
            <div class="header-icons">
                <button class="icon-btn">üí¨</button>
                <button class="icon-btn">ENG</button>
                <button class="icon-btn">‚ùì</button>
            </div>
        </header>

        <main class="content">
            <div class="card privileges-card">
                <div class="card-content">
                    <h2>Card Privileges</h2>
                    <p>Explore Credit/Debit Card deals! T&Cs apply...</p>
                    <button class="learn-more">Learn More</button>
                </div>
            </div>

            <div class="card trade-card">
                <div class="card-content">
                    <h2>Trade at 0.1% commission fee</h2>
                    <p>No min. fee. Limited time only.</p>
                    <button class="learn-more">Learn More</button>
                </div>
            </div>

            <div class="card money-lock-card">
                <div class="card-content">
                    <div class="highlights-label">HIGHLIGHTS</div>
                    <h2>Safeguard your funds with Money Lock</h2>
                    <div class="money-lock-preview">
                        <img src="money-lock.png" alt="Money Lock Interface">
                    </div>
                </div>
            </div>
        </main>

        <footer class="app-footer">
            <div class="quick-actions">
                <div class="action-item">
                    <div class="action-icon">üîí</div>
                    <span>Authorise Transaction</span>
                </div>
                <div class="action-item">
                    <div class="action-icon">üí≥</div>
                    <span>PayNow</span>
                </div>
                <div class="action-item">
                    <div class="action-icon">üì±</div>
                    <span>Scan QR</span>
                </div>
                <div class="action-item">
                    <div class="action-icon">‚ãØ</div>
                    <span>More</span>
                </div>
            </div>
            <button class="login-btn">Log in</button>
            <div class="bank-info">Banking Services Limited</div>
        </footer>
        
        <!-- Add the floating call button -->
        <a href="#" class="floating-call-btn" onclick="showPopup(event)">
            <span class="phone-icon">üìû</span>
        </a>

        <!-- Add the popup form -->
        <div id="contactPopup" class="popup">
            <div class="popup-content">
                <button class="close-btn" onclick="hidePopup()">‚úï</button>
                <h2>Contact Us</h2>
                <form id="contactForm" onsubmit="return false;">
                    <div class="form-group">
                        <label for="name">Name:</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number:</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                    <div class="call-status" style="display: none;">
                        <div class="status-indicator">
                            <div class="status-dot"></div>
                            <p id="callStatusText">Initializing call...</p>
                            <p id="callDuration">00:00</p>
                        </div>
                        <div class="call-controls">
                            <div class="numpad-toggle" onclick="toggleNumpad()">
                                <span>üìü</span>
                            </div>
                            <div class="mute-btn" onclick="toggleMute()">
                                <span id="muteIcon">üîä</span>
                            </div>
                        </div>
                        <div id="numpad" class="numpad" style="display: none;">
                            <div class="numpad-grid">
                                <button type="button" onclick="sendDTMF('1')">1</button>
                                <button type="button" onclick="sendDTMF('2')">2</button>
                                <button type="button" onclick="sendDTMF('3')">3</button>
                                <button type="button" onclick="sendDTMF('4')">4</button>
                                <button type="button" onclick="sendDTMF('5')">5</button>
                                <button type="button" onclick="sendDTMF('6')">6</button>
                                <button type="button" onclick="sendDTMF('7')">7</button>
                                <button type="button" onclick="sendDTMF('8')">8</button>
                                <button type="button" onclick="sendDTMF('9')">9</button>
                                <button type="button" onclick="sendDTMF('*')">*</button>
                                <button type="button" onclick="sendDTMF('0')">0</button>
                                <button type="button" onclick="sendDTMF('#')">#</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-buttons">
                        <button type="button" id="callButton" class="call-btn" onclick="startCall()">Call</button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            let localStream;
            let peerConnection;
            let callTimer;
            let callStartTime;
            let isMuted = false;
            let sipSession = null;

            // WebRTC Configuration using SBC ICE servers
            const configuration = {
                iceServers: sbcConfig.iceServers,
                iceTransportPolicy: 'all',
                bundlePolicy: 'max-bundle',
                rtcpMuxPolicy: 'require',
                sdpSemantics: 'unified-plan'
            };

            // SIP Configuration using dynamic SBC selection
            const defaultSbcType = 'ribbon'; // Default to Ribbon SBC
            const sbcConfig = getSBCConfig(defaultSbcType);
            
            const sipConfig = {
                uri: 'sip:user@' + sbcConfig.sipServer.domain,
                password: 'password',
                wsServers: sbcConfig.sipServer.wsUrl,
                register: true,
                userAgentString: 'Banking App WebRTC Client',
                transportOptions: {
                    wsServers: sbcConfig.sipServer.wsUrl,
                    traceSip: true
                },
                dtmfType: sbcConfig.media.dtmfType,
                mediaConstraints: {
                    audio: true,
                    video: false
                }
            };

            function showPopup(event) {
                event.preventDefault();
                const popup = document.getElementById('contactPopup');
                popup.style.display = 'flex';
            }

            function hidePopup() {
                const popup = document.getElementById('contactPopup');
                popup.style.display = 'none';
                stopCall();
            }

            async function startCall() {
                try {
                    const name = document.getElementById('name').value;
                    const phone = document.getElementById('phone').value;

                    if (!name || !phone) {
                        alert('Please enter both name and phone number');
                        return;
                    }

                    // Validate phone number format
                    const phoneRegex = /^[+]?[1-9]\d{1,14}$/;
                    if (!phoneRegex.test(phone.replace(/[\s()-]/g, ''))) {
                        alert('Please enter a valid phone number');
                        return;
                    }

                    // Show call status before requesting media
                    document.querySelector('.call-status').style.display = 'block';
                    
                    // Change call button to hangup button
                    const callButton = document.getElementById('callButton');
                    callButton.textContent = 'Hang Up';
                    callButton.className = 'hangup-btn';
                    callButton.onclick = stopCall;
                    
                    updateCallStatus('initializing');

                    // Check if SBC config is available
                    if (!sbcConfig) {
                        throw new Error('SBC configuration not available');
                    }

                    // Initialize SIP.js UA
                    const userAgent = new SIP.UA(sipConfig);
                    
                    userAgent.on('registered', () => {
                        console.log('SIP Registration successful');
                        updateCallStatus('connected');
                    });

                    userAgent.on('registrationFailed', (response) => {
                        console.error('SIP Registration failed:', response);
                        updateCallStatus('failed');
                        throw new Error('SIP registration failed');
                    });

                    try {
                        // Request audio stream with enhanced error handling
                        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    } catch (mediaError) {
                        console.error('Media access error:', mediaError);
                        updateCallStatus('failed');
                        throw new Error('Microphone access denied or not available');
                    }
                    
                    try {
                        // Initialize WebRTC connection
                        await initializeWebRTC();
                        
                        // Create SIP session with proper URI
                        const sipUri = `sip:${phone}@${sbcConfig.sipServer.domain}`;
                        sipSession = userAgent.invite(sipUri, {
                            media: {
                                constraints: {
                                    audio: true,
                                    video: false
                                },
                                render: {
                                    remote: document.createElement('audio')
                                }
                            }
                        });

                        sipSession.on('accepted', () => {
                            updateCallStatus('connected');
                            startCallTimer();
                        });

                        sipSession.on('failed', (response) => {
                            console.error('Call failed:', response);
                            updateCallStatus('failed');
                            throw new Error('Call connection failed');
                        });

                        sipSession.on('ended', () => {
                            updateCallStatus('ended');
                            stopCall();
                        });

                        updateCallStatus('connecting');
                        
                    } catch (webrtcError) {
                        console.error('WebRTC initialization error:', webrtcError);
                        updateCallStatus('failed');
                        throw new Error('Failed to establish call connection');
                    }
                    
                } catch (error) {
                    console.error('General error starting call:', error);
                    updateCallStatus('failed');
                    alert('Call failed: ' + error.message);
                    
                    // Cleanup on error
                    if (localStream) {
                        localStream.getTracks().forEach(track => track.stop());
                        localStream = null;
                    }
                    if (peerConnection) {
                        peerConnection.close();
                        peerConnection = null;
                    }
                    stopCall();
                }
            }

            function stopCall() {
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                
                // Reset call button
                const callButton = document.getElementById('callButton');
                callButton.textContent = 'Call';
                callButton.className = 'call-btn';
                callButton.onclick = startCall;
                
                document.querySelector('.call-status').style.display = 'none';
                stopCallTimer();
                updateCallStatus('ended');
            }

            function toggleMute() {
                if (localStream) {
                    localStream.getAudioTracks().forEach(track => {
                        track.enabled = !track.enabled;
                        isMuted = !track.enabled;
                    });
                    document.getElementById('muteIcon').textContent = isMuted ? 'üîá' : 'üîä';
                }
            }

            function toggleNumpad() {
                const numpad = document.getElementById('numpad');
                numpad.style.display = numpad.style.display === 'none' ? 'block' : 'none';
            }

            function sendDTMF(digit) {
                if (peerConnection && peerConnection.dtmf) {
                    peerConnection.dtmf.insertDTMF(digit);
                }
                console.log('Sending DTMF:', digit);
            }

            function updateCallStatus(status) {
                const statusText = document.getElementById('callStatusText');
                const statusDot = document.querySelector('.status-dot');
                const queueMessage = document.getElementById('queueMessage');
                
                switch(status) {
                    case 'initializing':
                        statusText.textContent = 'Initializing call...';
                        statusDot.className = 'status-dot initializing';
                        break;
                    case 'connecting':
                        statusText.textContent = 'Connecting...';
                        statusDot.className = 'status-dot connecting';
                        break;
                    case 'connected':
                        statusText.textContent = 'Connected';
                        statusDot.className = 'status-dot connected';
                        queueMessage.play();
                        startCallTimer();
                        break;
                    case 'failed':
                        statusText.textContent = 'Call Failed';
                        statusDot.className = 'status-dot failed';
                        stopCallTimer();
                        break;
                    case 'ended':
                        statusText.textContent = 'Call Ended';
                        statusDot.className = 'status-dot ended';
                        stopCallTimer();
                        break;
                }
            }

            function startCallTimer() {
                callStartTime = Date.now();
                callTimer = setInterval(updateCallDuration, 1000);
            }

            function stopCallTimer() {
                if (callTimer) {
                    clearInterval(callTimer);
                    callTimer = null;
                }
            }

            function updateCallDuration() {
                if (!callStartTime) return;
                
                const duration = Math.floor((Date.now() - callStartTime) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                
                document.getElementById('callDuration').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            async function initializeWebRTC() {
                try {
                    // Create new RTCPeerConnection
                    peerConnection = new RTCPeerConnection(configuration);

                    // Add local stream to peer connection
                    localStream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, localStream);
                    });

                    // Handle ICE candidate events
                    peerConnection.onicecandidate = event => {
                        if (event.candidate) {
                            // Send the candidate to the remote peer
                            console.log('New ICE candidate:', event.candidate);
                        }
                    };

                    // Handle ICE connection state changes
                    peerConnection.oniceconnectionstatechange = () => {
                        console.log('ICE connection state:', peerConnection.iceConnectionState);
                        if (peerConnection.iceConnectionState === 'failed') {
                            console.error('ICE connection failed');
                            updateCallStatus('failed');
                            alert('Connection failed. Please check your internet connection.');
                            stopCall();
                        }
                    };

                    // Handle connection state changes
                    peerConnection.onconnectionstatechange = () => {
                        console.log('Connection state:', peerConnection.connectionState);
                        switch(peerConnection.connectionState) {
                            case 'connected':
                                updateCallStatus('connected');
                                break;
                            case 'disconnected':
                                updateCallStatus('failed');
                                alert('Call disconnected. Please try again.');
                                stopCall();
                                break;
                            case 'failed':
                                updateCallStatus('failed');
                                alert('Connection failed. Please check your internet connection.');
                                stopCall();
                                break;
                            case 'closed':
                                updateCallStatus('ended');
                                break;
                        }
                    };

                    // Simulate connection for demo
                    setTimeout(() => updateCallStatus('connecting'), 1000);
                    setTimeout(() => updateCallStatus('connected'), 3000);

                } catch (error) {
                    console.error('Error initializing WebRTC:', error);
                    throw error; // Propagate error to be handled by startCall
                }
            }
        </script>
    </div>
</body>
</html>
<audio id="queueMessage" preload="auto">
    <source src="queue-message.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>